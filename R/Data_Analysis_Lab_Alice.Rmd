---
title: "Report: Testing hybrid vigor in the lab in response to Eimeria"
author: "Alice"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  pdf_document:
    toc: yes
    toc_depth: '4'
    fig_caption: yes        
    includes:  
      in_header: preamble-latex.tex
  word_document:
    toc: yes
    toc_depth: 4
    fig_caption: yes        
    includes:  
      in_header: preamble-latex.tex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# source("../R/dataPreparation.R")
source("../R/functions.R")
library(ggplot2)
library(gridExtra)
library(reshape2)
library(scales)
library(lme4)
library(lmerTest)
mytheme <- theme_bw()+
  theme(plot.title = element_text(size=22), plot.subtitle = element_text(size = 20),
        legend.text = element_text(size = 20),
        axis.text=element_text(size=20),
        axis.title=element_text(size=20,face="bold"),
        legend.key = element_rect(size = 5),
        legend.key.size = unit(1.5, 'lines'),
        strip.text = element_text(size=25))

calculateWeightLoss <- function(x, startingDay = 0){
  # define weight at infection
  A = x[x$dpi == startingDay, c("weight", "EH_ID")]
  names(A)[1] = "startingWeight"
  x = merge(x, A)
  # Cumulative sum of our weight loss
  x = x %>% 
    group_by(EH_ID) %>% 
    dplyr::arrange(dpi, .by_group = TRUE) %>%
    dplyr::mutate(relativeWeight = weight / startingWeight * 100)
  x = data.frame(x)
  return(x)
}

calculateOPG <- function(ExpeDF){
  ExpeDF$mean_Neubauer <- 
    (ExpeDF$Neubauer1 + ExpeDF$Neubauer2 + ExpeDF$Neubauer3 + ExpeDF$Neubauer4) / 4
  ExpeDF$OPG <- ExpeDF$mean_Neubauer * 10000 / ExpeDF$dilution_ml / ExpeDF$fecweight
  return(ExpeDF)
}
```

# Expe_001, March 2017, Francisca's experiment. infection with E64 and Eflab

```{r setupExpe1, echo=FALSE, warning=FALSE}
# ExpeDF need at least the following:
# "OPG", "EH_ID", "dpi", "weight", "EH_ID", "infection_isolate", "Mouse_strain"
ExpeDF_001 <- read.csv("../data/3_recordingTables/Exp001_May2017_crossing_infection.csv")

# Add mice subspecies info
ExpeDF_001$Mouse_subspecies <- "F1 hybrids"
ExpeDF_001$Mouse_subspecies[ExpeDF_001$Mouse_strain == "PWD"] <- "M.m.musculus"
ExpeDF_001$Mouse_subspecies[ExpeDF_001$Mouse_strain == "WSB"] <- "M.m.domesticus"
ExpeDF_001$Mouse_subspecies <- factor(ExpeDF_001$Mouse_subspecies,
                                      levels = c("M.m.domesticus", "F1 hybrids", "M.m.musculus"))

# Mouse_strain: West should always be left
ExpeDF_001$Mouse_strain <- factor(ExpeDF_001$Mouse_strain,
                                  levels = c("WSB", "WP", "PWD"),
                                  labels = c("M.m.domesticus \n(WSB)",
                                             "F1 hybrids \n(WP)",
                                             "M.m.musculus \n(PWD)"))

# Enter Eimeria species
ExpeDF_001$Eimeria_species[ExpeDF_001$infection_isolate %in% c("E88", "Eflab", "EfLab")] = "E.falciformis"
ExpeDF_001$Eimeria_species[ExpeDF_001$infection_isolate %in% c("E64", "EI64", "E139")] = "E.ferrisi"

# calculate relative weight loss compared to dpi3
ExpeDF_001 <- calculateWeightLoss(ExpeDF_001, startingDay = 3)

# Set mice that died before the end of experiment at 20% weight loss (maximum) on last day
# deadBeforeEnd <- names(table(ExpeDF_001$EH_ID))[!table(ExpeDF_001$EH_ID) %in% 12]

# calculate summary statistics on weight loss
summaryWeight_001 <- summarySE(ExpeDF_001, measurevar = "relativeWeight",
                           groupvars=c("Mouse_strain", "Mouse_subspecies", "Eimeria_species",
                                       "infection_isolate", "dpi"), na.rm = T)
summaryWeight_001$ci[is.na(summaryWeight_001$ci)] <- 0

# calculate summary statistics on oocysts shedding
summaryOocysts_001 <-summarySE(ExpeDF_001, measurevar="OPG", 
                           groupvars=c("Mouse_strain", "Mouse_subspecies", "Eimeria_species",
                                       "infection_isolate", "dpi"), na.rm = T)
summaryOocysts_001$ci[is.na(summaryOocysts_001$ci)] <- 0

# Add OPG status
ExpeDF_001$OPGstatus[is.na(ExpeDF_001$OPG)] = "na"
ExpeDF_001$OPGstatus[!is.na(ExpeDF_001$OPG) & ExpeDF_001$OPG > 0] = "positive"
ExpeDF_001$OPGstatus[!is.na(ExpeDF_001$OPG) & ExpeDF_001$OPG == 0] = "negative"
ExpeDF_001$OPGstatus = as.factor(ExpeDF_001$OPGstatus)
```

## 1. Weight loss
```{r weightalong1, echo=FALSE, warning=FALSE, fig.width = 12, fig.height = 10}
ggplot(ExpeDF_001, aes(x = dpi, y = weight, fill = OPGstatus)) +
  geom_rect(aes(xmin = 3, xmax = 8, ymin = -Inf, ymax = Inf), fill = "lightgrey", alpha = .5) +
  geom_line(aes(group = EH_ID, col = Mouse_strain), size = 2, alpha = 0.5) +
  scale_color_manual(values = c("blue", "purple", "red")) +
  geom_point(size=4, pch = 21, color = "black")+
  scale_fill_manual(values = c("lightgrey", "black", "yellow")) +
  mytheme +
  facet_grid(Mouse_strain ~ infection_isolate, scales = "free_y", space = "free") +
  scale_x_continuous(breaks = 0:11, name = "Day post infection (dpi)") +
  scale_y_continuous(name = "Weight (g)") +
  theme(strip.text.y = element_text(size = 15)) +
  theme(legend.position="none") +
  ggtitle("Weight along experiment per individual", subtitle = "yellow : oocysts detected in feces")

ggplot(ExpeDF_001, aes(x = dpi, y = relativeWeight, fill = OPGstatus)) +
  # geom_rect(aes(xmin = 3, xmax = 8, ymin = 80, ymax = 110), fill = "lightgrey", alpha = .5) +
  geom_line(aes(group = EH_ID, col = Mouse_strain), size = 2, alpha = 0.5) +
  scale_color_manual(values = c("blue", "purple", "red")) +
  geom_point(size=4, pch = 21, color = "black")+
  scale_fill_manual(values = c("lightgrey", "black", "yellow")) +
  mytheme +
  facet_grid(Mouse_strain ~ infection_isolate, scales = "free_y", space = "free") +
  scale_x_continuous(breaks = 0:11, name = "Day post infection (dpi)") +
  scale_y_continuous(name = "Weight relative to dpi3 (%)") +
  coord_cartesian(ylim = c(80, 110)) +
  theme(strip.text.y = element_text(size = 15)) +
  # theme(legend.position="none") +
  ggtitle("Relative weight along experiment compared to dpi3", subtitle = "yellow : oocysts detected in feces")
```

```{r weightalongsum1, echo=FALSE, warning=FALSE, fig.width = 12, fig.height = 10}
ggplot(summaryWeight_001, aes(x = dpi, y = relativeWeight))+
  # geom_rect(aes(xmin = 3, xmax = 8, ymin = -Inf, ymax = Inf), fill = "lightgrey", alpha = .5) +
  geom_errorbar(aes(ymin = relativeWeight - ci, ymax = relativeWeight + ci, col = Mouse_strain)) +
  geom_line(aes(group = Mouse_strain, col = Mouse_strain), size = 2, alpha = 0.5) +
  geom_point(aes(fill = Mouse_strain), size=4, pch = 21, color = "black") +
  scale_color_manual(values = c("blue", "purple", "red")) +
  scale_fill_manual(values = c("blue", "purple", "red")) +
  mytheme +
  facet_grid(. ~ infection_isolate, scales = "free_y", space = "free") +
  scale_x_continuous(breaks = 0:11, name = "Day post infection (dpi)") +
  scale_y_continuous(name = "Weight relative to dpi3 (%)") +
  coord_cartesian(ylim = c(85, 115)) +
  ggtitle("Mean relative weight along experiment compared to dpi3")
```

For statistical analysis, we compare the maximum relative weight loss between the different groups. We limit our analysis to the period : dpi3 to dpi8 (symptomatic period for E64 strain).

```{r stats1_64, echo=FALSE, warning=FALSE, fig.width = 12, fig.height = 10}
ExpeDF_001Symptomatic_64 <- ExpeDF_001[ExpeDF_001$dpi %in% 3:8 & ExpeDF_001$Eimeria_species %in% "E.ferrisi" ,]
max.loss_001_64 <- do.call("rbind", by(ExpeDF_001Symptomatic_64, ExpeDF_001Symptomatic_64$EH_ID, function (x){
  m.loss <- which(x$relativeWeight == min(x$relativeWeight, na.rm=TRUE))
  x[m.loss,]
}))

ggplot(max.loss_001_64, aes(Mouse_strain,100-relativeWeight, color=infection_isolate)) +
  geom_boxplot(color = "black")+
  ggtitle("Maximum weigth loss during the symptomatic phase") +
  facet_wrap(~infection_isolate) +
  geom_jitter(width=0.1, size=7, pch = 21,
              color = "black", aes(fill = Mouse_strain), alpha = 0.8) +
  labs(y= "Maximum weigth loss relative to weight at dpi 3", x= "Mouse strain")+
  scale_fill_manual(values = c("blue", "purple", "red")) +
  mytheme +
  theme(legend.position="none")

max.loss_001_64$Mouse_strain <- factor(max.loss_001_64$Mouse_strain, 
                                    levels = c("F1 hybrids \n(WP)",
                                               "M.m.domesticus \n(WSB)",
                                               "M.m.musculus \n(PWD)"))

kruskal.test(relativeWeight ~ Mouse_strain, data = max.loss_001_64)
pairwise.wilcox.test(max.loss_001_64$relativeWeight, max.loss_001_64$Mouse_strain,
                 p.adjust.method = "BH")
```

For statistical analysis, we compare the maximum relative weight loss between the different groups. We limit our analysis to the period : dpi7 to dpi11 (symptomatic period for E88 strain).

```{r stats1_88, echo=FALSE, warning=FALSE, fig.width = 12, fig.height = 10}
ExpeDF_001Symptomatic_88 <- ExpeDF_001[ExpeDF_001$dpi %in% 7:11 & ExpeDF_001$Eimeria_species %in% "E.falciformis" ,]
max.loss_001_88 <- do.call("rbind", by(ExpeDF_001Symptomatic_88, ExpeDF_001Symptomatic_88$EH_ID, function (x){
  m.loss <- which(x$relativeWeight == min(x$relativeWeight, na.rm=TRUE))
  x[m.loss,]
}))

ggplot(max.loss_001_88, aes(Mouse_strain,100-relativeWeight, color=infection_isolate)) +
  geom_boxplot(color = "black")+
  ggtitle("Maximum weigth loss during the symptomatic phase") +
  facet_wrap(~infection_isolate) +
  geom_jitter(width=0.1, size=7, pch = 21,
              color = "black", aes(fill = Mouse_strain), alpha = 0.8) +
  labs(y= "Maximum weigth loss relative to weight at dpi 3", x= "Mouse strain")+
  scale_fill_manual(values = c("blue", "purple", "red")) +
  mytheme +
  theme(legend.position="none")

max.loss_001_88$Mouse_strain <- factor(max.loss_001_88$Mouse_strain, 
                                    levels = c("F1 hybrids \n(WP)",
                                               "M.m.domesticus \n(WSB)",
                                               "M.m.musculus \n(PWD)"))

kruskal.test(relativeWeight ~ Mouse_strain, data = max.loss_001_88)
pairwise.wilcox.test(max.loss_001_88$relativeWeight, max.loss_001_88$Mouse_strain,
                 p.adjust.method = "BH")
```

## 2. Parasite shedding

```{r OPGalong1, echo=FALSE, warning=FALSE, fig.width = 12, fig.height = 10}
ggplot(ExpeDF_001, aes(x = dpi, y = OPG, fill = infection_isolate))+
  geom_rect(aes(xmin = 3, xmax = 8, ymin = -Inf, ymax = Inf), fill = "lightgrey", alpha = .5) +
  geom_line(aes(group = EH_ID, col = Mouse_strain), alpha = 0.5, size = 2) +
  geom_point(size=3, aes(color = Mouse_strain))+
  scale_color_manual(values = c("blue", "purple", "red")) +
  facet_grid(Mouse_strain ~ infection_isolate) +
  mytheme +
  scale_x_continuous(breaks = 0:11, name = "Day post infection (dpi)") +
  ylab("Oocysts shedding along infection (OPG)") +
  ggtitle("Oocyst shedding along experiment") +
  theme(legend.position="none") 
```

```{r OPGalongsum1, echo=FALSE, warning=FALSE, fig.width = 12, fig.height = 10}
ggplot(summaryOocysts_001, aes(x = dpi, y = OPG))+
  geom_rect(aes(xmin = 3, xmax = 8, ymin = -Inf, ymax = Inf), fill = "lightgrey", alpha = .5) +
  geom_errorbar(aes(ymin = OPG - ci, ymax = OPG + ci,  col= Mouse_strain)) +
  geom_line(aes(group = Mouse_strain, col = Mouse_strain), size = 2, alpha = 0.5) +
  geom_point(aes(fill = Mouse_strain), size=4, pch = 21, color = "black") +
  scale_color_manual(values = c("blue", "purple", "red")) +
  scale_fill_manual(values = c("blue", "purple", "red")) +
  mytheme +
  facet_grid(. ~ infection_isolate) +
  scale_x_continuous(breaks = 0:11, name = "Day post infection (dpi)") +
  scale_y_continuous(name = "Oocysts shedding along infection (OPG)") +
  ggtitle("Mean oocysts shedding along experiment")
```


```{r stats1opg_64, echo=FALSE, warning=FALSE, fig.width = 12, fig.height = 10}
# Cumulative OPG along experiment
all.sum.oocysts_001_64 <- do.call("rbind", by(ExpeDF_001[ExpeDF_001$Eimeria_species %in% "E.ferrisi",], ExpeDF_001[ExpeDF_001$Eimeria_species %in% "E.ferrisi", "EH_ID"], function (x){
  x$sum.oo <- sum(x$OPG, na.rm = TRUE)
  x
}))
sum.oocysts_001_64 <- all.sum.oocysts_001_64[!duplicated(all.sum.oocysts_001_64$EH_ID),]

ggplot(sum.oocysts_001_64, aes(Mouse_strain, sum.oo, color=infection_isolate)) +
  geom_boxplot(color = "black")+
  ggtitle("Sum of oocysts shed along the experiment (E64)") +
  geom_jitter(width=0.1, size=7, pch = 21,
              color = "black", aes(fill = Mouse_strain), alpha = 0.8) +
  labs(y= "Sum of oocysts shed along experiment, OPG (oocysts per gram)", x= "Mouse strain")+
  scale_fill_manual(values = c("blue", "purple", "red")) +
  mytheme +
  theme(legend.position="none")

sum.oocysts_001_64$Mouse_strain <- factor(sum.oocysts_001_64$Mouse_strain, 
                                    levels = c("F1 hybrids \n(WP)",
                                               "M.m.domesticus \n(WSB)",
                                               "M.m.musculus \n(PWD)"))

kruskal.test(sum.oo ~ Mouse_strain, data = sum.oocysts_001_64)
pairwise.wilcox.test(sum.oocysts_001_64$sum.oo, sum.oocysts_001_64$Mouse_strain,
                 p.adjust.method = "BH")
```

```{r stats1opg_88, echo=FALSE, warning=FALSE, fig.width = 12, fig.height = 10}
# Cumulative OPG along experiment
all.sum.oocysts_001_88 <- do.call("rbind", by(ExpeDF_001[ExpeDF_001$Eimeria_species %in% "E.ferrisi",], ExpeDF_001[ExpeDF_001$Eimeria_species %in% "E.ferrisi", "EH_ID"], function (x){
  x$sum.oo <- sum(x$OPG, na.rm = TRUE)
  x
}))
sum.oocysts_001_88 <- all.sum.oocysts_001_88[!duplicated(all.sum.oocysts_001_88$EH_ID),]

ggplot(sum.oocysts_001_88, aes(Mouse_strain, sum.oo, color=infection_isolate)) +
  geom_boxplot(color = "black")+
  ggtitle("Sum of oocysts shed along the experiment (E88)") +
  geom_jitter(width=0.1, size=7, pch = 21,
              color = "black", aes(fill = Mouse_strain), alpha = 0.8) +
  labs(y= "Sum of oocysts shed along experiment, OPG (oocysts per gram)", x= "Mouse strain")+
  scale_fill_manual(values = c("blue", "purple", "red")) +
  mytheme +
  theme(legend.position="none")

sum.oocysts_001_88$Mouse_strain <- factor(sum.oocysts_001_88$Mouse_strain, 
                                    levels = c("F1 hybrids \n(WP)",
                                               "M.m.domesticus \n(WSB)",
                                               "M.m.musculus \n(PWD)"))

kruskal.test(sum.oo ~ Mouse_strain, data = sum.oocysts_001_88)
pairwise.wilcox.test(sum.oocysts_001_88$sum.oo, sum.oocysts_001_88$Mouse_strain,
                 p.adjust.method = "BH")
```

## 3. Comparison host/parasite proxy

```{r plotComp1_64, echo=FALSE, warning=FALSE, fig.width = 12, fig.height = 10, fig.cap="\\label{fig:plotComp1} Weight as a function of OPG"}
## Plot comparison weightloss vs OPG, all day counfounded
ggplot(ExpeDF_001Symptomatic_64, 
       aes(x = OPG+1, y = relativeWeight, group = Mouse_strain, fill = Mouse_strain)) +
  geom_point(pch = 21, size=3)  +
  geom_smooth(method = "lm", col = "grey") +
  scale_y_continuous(name = "Weight relative to infection (%)") +
  scale_x_log10() +
  coord_cartesian(ylim =  c(80,110)) +
  ggtitle("Relative weight loss compared to dpi3, during the symptomatic phase, vs parasite outcome (E64)") +
  mytheme
```

```{r plotComp1_88, echo=FALSE, warning=FALSE, fig.width = 12, fig.height = 10, fig.cap="\\label{fig:plotComp1} Weight as a function of OPG"}
## Plot comparison weightloss vs OPG, all day counfounded
ggplot(ExpeDF_001Symptomatic_88, 
       aes(x = OPG+1, y = relativeWeight, group = Mouse_strain, fill = Mouse_strain)) +
  geom_point(pch = 21, size=3)  +
  geom_smooth(method = "lm", col = "grey") +
  scale_y_continuous(name = "Weight relative to infection (%)") +
  scale_x_log10() +
  coord_cartesian(ylim =  c(80,110)) +
  ggtitle("Relative weight loss compared to dpi3, during the symptomatic phase, vs parasite outcome (E88)") +
  mytheme
```

# Pass001: Nov 2017, passaging 4 isolates (some missing data)
# (Eflab, E88, E139, E64) in NMRI. 2 mice per cage. Only OPG recorded


```{r prepPass1, echo=FALSE}
PassDF_001 <- read.csv("../data/3_recordingTables/passaging_extra/Pass001_oocystsonly_Nov2017_Passaging_4Eimeria.csv")
PassDF_001$weightRelativeToInfection <- NA
```
## Parasite shedding

```{r Pass001, echo=FALSE, warning=FALSE, fig.width = 12, fig.height = 10}
ggplot(PassDF_001, aes(x = dpi, y = OPG, fill = infection_isolate))+
  geom_line(aes(group = EH_ID, col = Mouse_strain), alpha = 0.5, size = 2) +
  geom_point(size=3, aes(color = Mouse_strain))+
  scale_color_manual(values = c("blue", "purple", "red")) +
  facet_grid(Mouse_strain ~ infection_isolate, scales = "free") +
  mytheme +
  scale_x_continuous(breaks = 0:11, name = "Day post infection (dpi)") +
  ylab("Oocysts shedding along infection (OPG)") +
  ggtitle("Oocyst shedding along experiment") +
  theme(legend.position="none") 
```

# Expe_002: March 2018, NMRI mice infected with 4 *Eimeria* strains (Eflab, E88, E139, E64)

```{r setupExpe2, echo=FALSE, warning=FALSE}
ExpeDF_002 <- read.csv("../data/3_recordingTables/Exp002_March2018_NMRI_4strains_RECORDweightAndOocysts.csv")
ExpeDF_002$Mouse_strain <- "NMRI"
ExpeDF_002$EH_ID <- paste0("mouse_", ExpeDF_002$EH_ID)
ExpeDF_002$Mouse_subspecies = ExpeDF_002$Mouse_strain

# Calculate weight loss
ExpeDF_002 <- calculateWeightLoss(ExpeDF_002, startingDay = 0)

# Calculate OPG
ExpeDF_002 <- calculateOPG(ExpeDF_002)

# WRONG OPG just for plotting, for dpi 11 (we forgot to weight the feces...)
ExpeDF_002$OPG_temp[
  !is.na(ExpeDF_002$mean_Neubauer) & is.na(ExpeDF_002$OPG)] = 0

ExpeDF_002$OPG_temp[
  !is.na(ExpeDF_002$mean_Neubauer) & is.na(ExpeDF_002$OPG) & ExpeDF_002$mean_Neubauer > 0] = 1

ExpeDF_002$OPG[is.na(ExpeDF_002$OPG)] = ExpeDF_002$OPG_temp[is.na(ExpeDF_002$OPG)]

# Enter Eimeria species
ExpeDF_002$Eimeria_species[ExpeDF_002$infection_isolate %in% c("E88", "Eflab", "EfLab")] <- "E.falciformis"
ExpeDF_002$Eimeria_species[ExpeDF_002$infection_isolate %in% c("E64", "EI64", "E139")] = "E.ferrisi"

# calculate summary statistics on weight loss
summaryWeight_002 <- summarySE(ExpeDF_002, measurevar = "relativeWeight",
                           groupvars=c("Mouse_strain", "Mouse_subspecies", "Eimeria_species",
                                       "infection_isolate", "dpi"), na.rm = T)
summaryWeight_002$ci[is.na(summaryWeight_002$ci)] <- 0

# calculate summary statistics on oocysts shedding
summaryOocysts_002 <-summarySE(ExpeDF_002, measurevar="OPG", 
                           groupvars=c("Mouse_strain", "Mouse_subspecies", "Eimeria_species",
                                       "infection_isolate", "dpi"), na.rm = T)
summaryOocysts_002$ci[is.na(summaryOocysts_002$ci)] <- 0

# Add OPG status
ExpeDF_002$OPGstatus[is.na(ExpeDF_002$OPG)] = "na"
ExpeDF_002$OPGstatus[!is.na(ExpeDF_002$OPG) & ExpeDF_002$OPG > 0] = "positive"
ExpeDF_002$OPGstatus[!is.na(ExpeDF_002$OPG) & ExpeDF_002$OPG == 0] = "negative"
ExpeDF_002$OPGstatus = as.factor(ExpeDF_002$OPGstatus)
```

## 1. Weight loss
```{r weightalong2, echo=FALSE, warning=FALSE, fig.width = 12, fig.height = 10}
ggplot(ExpeDF_002, aes(x = dpi, y = weight, fill = OPGstatus)) +
  geom_line(aes(group = EH_ID, col = Mouse_strain), size = 2, alpha = 0.5) +
  # scale_color_manual(values = c("blue", "purple", "red")) +
  geom_point(size=4, pch = 21, color = "black")+
  scale_fill_manual(values = c("lightgrey", "black", "yellow")) +
  mytheme +
  facet_grid(Mouse_strain ~ infection_isolate, scales = "free_y", space = "free") +
  scale_x_continuous(breaks = 0:11, name = "Day post infection (dpi)") +
  scale_y_continuous(name = "Weight (g)") +
  theme(strip.text.y = element_text(size = 15)) +
  # theme(legend.position="none") +
  ggtitle("Weight along experiment per individual", subtitle = "yellow : oocysts detected in feces")

ggplot(ExpeDF_002, aes(x = dpi, y = relativeWeight, fill = OPGstatus)) +
  geom_line(aes(group = EH_ID, col = Mouse_strain), size = 2, alpha = 0.5) +
  # scale_color_manual(values = c("blue", "purple", "red")) +
  geom_point(size=4, pch = 21, color = "black")+
  scale_fill_manual(values = c("lightgrey", "black", "yellow")) +
  mytheme +
  facet_grid(Mouse_strain ~ infection_isolate, scales = "free_y", space = "free") +
  scale_x_continuous(breaks = 0:11, name = "Day post infection (dpi)") +
  scale_y_continuous(name = "Weight relative to dpi0 (%)") +
  coord_cartesian(ylim = c(80, 110)) +
  theme(strip.text.y = element_text(size = 15)) +
  # theme(legend.position="none") +
  ggtitle("Relative weight along experiment compared to dpi0", subtitle = "yellow : oocysts detected in feces")
```

```{r weightalongsum2, echo=FALSE, warning=FALSE, fig.width = 12, fig.height = 10}
ggplot(summaryWeight_002, aes(x = dpi, y = relativeWeight))+
  geom_errorbar(aes(ymin = relativeWeight - ci, ymax = relativeWeight + ci)) +
  geom_line(aes(group = Mouse_strain, col = Mouse_strain), size = 2, alpha = 0.5) +
  geom_point(aes(fill = Mouse_strain), size=4, pch = 21, color = "black") +
  # scale_color_manual(values = c("blue", "purple", "red")) +
  # scale_fill_manual(values = c("blue", "purple", "red")) +
  mytheme +
  facet_grid(Mouse_strain ~ infection_isolate, scales = "free_y", space = "free") +
  scale_x_continuous(breaks = 0:11, name = "Day post infection (dpi)") +
  scale_y_continuous(name = "Weight relative to dpi0 (%)") +
  coord_cartesian(ylim = c(85, 115)) +
  theme(legend.position="none") +
  ggtitle("Mean relative weight along experiment compared to dpi0")
```

## 2. Parasite shedding

```{r OPGalong2, echo=FALSE, warning=FALSE, fig.width = 12, fig.height = 10}
ggplot(ExpeDF_002, aes(x = dpi, y = OPG, fill = infection_isolate))+
  geom_line(aes(group = EH_ID, col = Mouse_strain), alpha = 0.5, size = 2) +
  geom_point(size=3, aes(color = Mouse_strain))+
  scale_color_manual(values = c("blue", "purple", "red")) +
  facet_grid(Mouse_strain ~ infection_isolate) +
  mytheme +
  scale_x_continuous(breaks = 0:11, name = "Day post infection (dpi)") +
  ylab("Oocysts shedding along infection (OPG)") +
  ggtitle("Oocyst shedding along experiment") +
  theme(legend.position="none") 
```

```{r OPGalongsum2, echo=FALSE, warning=FALSE, fig.width = 12, fig.height = 10}
ggplot(summaryOocysts_002, aes(x = dpi, y = OPG))+
  geom_errorbar(aes(ymin = OPG - ci, ymax = OPG + ci)) +
  geom_line(aes(group = Mouse_strain, col = Mouse_strain), size = 2, alpha = 0.5) +
  geom_point(aes(fill = Mouse_strain), size=4, pch = 21, color = "black") +
  scale_color_manual(values = c("blue", "purple", "red")) +
  scale_fill_manual(values = c("blue", "purple", "red")) +
  mytheme +
  facet_grid(Mouse_strain ~ infection_isolate) +
  scale_x_continuous(breaks = 0:11, name = "Day post infection (dpi)") +
  scale_y_continuous(name = "Oocysts shedding along infection (OPG)") +
  theme(legend.position="none") +
  ggtitle("Mean oocysts shedding along experiment")
```

## 3. Comparison host/parasite proxy

```{r plotComp2, echo=FALSE, warning=FALSE, fig.width = 12, fig.height = 10, fig.cap="\\label{fig:plotComp1} Weight as a function of OPG"}
## Plot comparison weightloss vs OPG, all day counfounded
ggplot(ExpeDF_002, 
       aes(x = OPG+1, y = relativeWeight, group = infection_isolate, fill = infection_isolate)) +
  geom_point(pch = 21, size=3)  +
  facet_grid(. ~ Eimeria_species, scales = "free_y", space = "free") +
  geom_smooth(method = "lm", col = "grey") +
  scale_y_continuous(name = "Weight relative to infection (%)") +
  scale_x_log10() +
  coord_cartesian(ylim =  c(80,110)) +
  ggtitle("Relative weight loss compared to dpi0, during the symptomatic phase, vs parasite outcome") +
  mytheme
```

# Expe_003 & Expe_004, April-May 2018, first batch Parental strains (F0) BUSNA, STRA, SCHUNT, PWD, infection with Eferrisi (E64 and E139) [2 batches]

```{r setupExpe3, echo=FALSE, warning=FALSE}
oo <- read.csv("../data/3_recordingTables/Exp003_April2018_wildmice_Eferrisi_Firstbatch_RECORDoocysts.csv")
we <- read.csv("../data/3_recordingTables/Exp003_April2018_wildmice_Eferrisi_Firstbatch_RECORDweight.csv")
design <- read.csv("../data/2_designTables/Exp003_April2018_wildmice_Eferrisi_Firstbatch_DESIGN.csv")
ExpeDF_003 <- merge(oo, we, all = T)
ExpeDF_003 <- merge(ExpeDF_003, design, by = "EH_ID", all = T)

oo <- read.csv("../data/3_recordingTables/Exp004_June2018_wildmice_Eferrisi_Secondbatch_RECORDoocysts.csv")
we <- read.csv("../data/3_recordingTables/Exp004_June2018_wildmice_Eferrisi_Secondbatch_RECORDweight.csv")
design <- read.csv("../data/2_designTables/Exp004_June2018_wildmice_Eferrisi_Secondbatch_DESIGN.csv")
ExpeDF_004 <- merge(oo, we, all = T)
ExpeDF_004 <- merge(ExpeDF_004, design, by = "EH_ID", all = T)
rm(design, oo, we)
ExpeDF_004$Mouse_strain <- ExpeDF_004$Strain
ExpeDF_004$Exp_ID <- "ExpeDF_004"

ExpeDF_003_4 <- merge(ExpeDF_003, ExpeDF_004, all = TRUE)

# Keep for dpi 0 to 11
ExpeDF_003_4 <- ExpeDF_003_4[ExpeDF_003_4$dpi %in% 0:11, ]# remove stabilisation period

# correct abherante value
ExpeDF_003_4[ExpeDF_003_4$EH_ID %in% "LM0137" & ExpeDF_003_4$weight %in% 17.6, "weight"] <- NA

# Add mice subspecies
ExpeDF_003_4$Mouse_subspecies <- "M.m.domesticus"
ExpeDF_003_4$Mouse_subspecies[ExpeDF_003_4$Mouse_strain %in% c("BUSNA", "PWD")] <- "M.m.musculus"

# Mouse_strain: West should always be left 
ExpeDF_003_4$Mouse_strain <- factor(ExpeDF_003_4$Mouse_strain,
                                  levels = c("STRA", "BUSNA", "SCHUNT", "PWD"),
                                  labels = c("M.m.domesticus \n(STRA)", 
                                             "M.m.musculus \n(BUSNA)", 
                                             "M.m.domesticus \n(SCHUNT)",
                                             "M.m.musculus \n(PWD)"))
# Enter Eimeria species
ExpeDF_003_4$Eimeria_species[ExpeDF_003_4$infection_isolate %in% c("E88", "Eflab", "EfLab")] = "E.falciformis"
ExpeDF_003_4$Eimeria_species[ExpeDF_003_4$infection_isolate %in% c("E64", "EI64", "E139")] = "E.ferrisi"

# calculate relative weight loss compared to dpi3
ExpeDF_003_4 <- calculateWeightLoss(ExpeDF_003_4, startingDay = 3)

# calculate OPG 
# rename 
names(ExpeDF_003_4) <- gsub("oocyst_sq", "Neubauer", names(ExpeDF_003_4))
names(ExpeDF_003_4) <- gsub("dilution", "dilution_ml", names(ExpeDF_003_4))
ExpeDF_003_4$fecweight <- as.numeric(as.character(ExpeDF_003_4$fecweight))

ExpeDF_003_4 <- calculateOPG(ExpeDF = ExpeDF_003_4)

# Add OPG status
ExpeDF_003_4$OPGstatus[is.na(ExpeDF_003_4$OPG)] = "na"
ExpeDF_003_4$OPGstatus[!is.na(ExpeDF_003_4$OPG) & ExpeDF_003_4$OPG > 0] = "positive"
ExpeDF_003_4$OPGstatus[!is.na(ExpeDF_003_4$OPG) & ExpeDF_003_4$OPG == 0] = "negative"
ExpeDF_003_4$OPGstatus = as.factor(ExpeDF_003_4$OPGstatus)

# calculate summary statistics on weight loss
summaryWeight_003_4 <- summarySE(ExpeDF_003_4, measurevar = "relativeWeight",
                           groupvars=c("Mouse_strain", "Mouse_subspecies", "Eimeria_species",
                                       "infection_isolate", "dpi"), na.rm = T)
summaryWeight_003_4$ci[is.na(summaryWeight_003_4$ci)] <- 0

# calculate summary statistics on oocysts shedding
summaryOocysts_003_4 <-summarySE(ExpeDF_003_4, measurevar="OPG", 
                           groupvars=c("Mouse_strain", "Mouse_subspecies", "Eimeria_species",
                                       "infection_isolate", "dpi"), na.rm = T)
summaryOocysts_003_4$ci[is.na(summaryOocysts_003_4$ci)] <- 0
```

## 1. Weight loss
```{r weightalong3, echo=FALSE, warning=FALSE, fig.width = 12, fig.height = 10}
ggplot(ExpeDF_003_4, aes(x = dpi, y = weight, fill = OPGstatus)) +
  geom_rect(aes(xmin = 3, xmax = 8, ymin = -Inf, ymax = Inf), fill = "lightgrey", alpha = .5) +
  geom_line(aes(group = EH_ID, col = Mouse_strain), size = 2, alpha = 0.5) +
  geom_point(size=4, pch = 21, color = "black")+
  scale_fill_manual(values = c("lightgrey", "black", "yellow")) +
  mytheme +
  facet_grid(. ~ infection_isolate, scales = "free") +
  scale_x_continuous(breaks = 0:11, name = "Day post infection (dpi)") +
  scale_y_continuous(name = "Weight (g)") +
  theme(strip.text.y = element_text(size = 15)) +
  # theme(legend.position="none") +
  ggtitle("Weight along experiment per indiidual", subtitle = "yellow : oocysts detected in feces")

ggplot(ExpeDF_003_4, aes(x = dpi, y = relativeWeight, fill = OPGstatus)) +
  geom_rect(aes(xmin = 3, xmax = 8, ymin = 80, ymax = 110), fill = "lightgrey", alpha = .5) +
  geom_line(aes(group = EH_ID, col = Mouse_strain), size = 2, alpha = 0.5) +
  geom_point(size=4, pch = 21, color = "black")+
  scale_fill_manual(values = c("lightgrey", "black", "yellow")) +
  mytheme +
  facet_grid(Mouse_strain ~ infection_isolate, scales = "free_y", space = "free") +
  scale_x_continuous(breaks = 0:11, name = "Day post infection (dpi)") +
  scale_y_continuous(name = "Weight relative to dpi3 (%)") +
  coord_cartesian(ylim = c(80, 110)) +
  theme(strip.text.y = element_text(size = 15)) +
  theme(legend.position="none") +
  ggtitle("Relative weight along experiment compared to dpi3", subtitle = "yellow : oocysts detected in feces")
```

```{r weightalongsum3, echo=FALSE, warning=FALSE, fig.width = 12, fig.height = 10}
ggplot(summaryWeight_003_4, aes(x = dpi, y = relativeWeight))+
  geom_rect(aes(xmin = 3, xmax = 8, ymin = -Inf, ymax = Inf), fill = "lightgrey", alpha = .5) +
  geom_errorbar(aes(ymin = relativeWeight - ci, ymax = relativeWeight + ci, col = Mouse_strain),
                alpha = 0.5) +
  geom_line(aes(group = Mouse_strain, col = Mouse_strain), size = 2) +
  geom_point(aes(fill = Mouse_strain), size=4, pch = 21, color = "black") +
  # scale_color_manual(values = c("blue", "purple", "red")) +
  # scale_fill_manual(values = c("blue", "purple", "red")) +
  mytheme +
  facet_grid(. ~ infection_isolate) +
  scale_x_continuous(breaks = 0:11, name = "Day post infection (dpi)") +
  scale_y_continuous(name = "Weight relative to dpi3 (%)") +
  # theme(legend.position="none") +
  ggtitle("Mean relative weight along experiment compared to dpi3")
```

For statistical analysis, we compare the maximum relative weight loss between the different groups. We limit our analysis to the period : dpi3 to dpi8 (symptomatic period for E64 strain).

```{r stats3, echo=FALSE, warning=FALSE, fig.width = 12, fig.height = 10}
ExpeDF_003_4Symptomatic <- ExpeDF_003_4[ExpeDF_003_4$dpi %in% 3:8,]
max.loss_003_4 <- do.call("rbind", by(ExpeDF_003_4Symptomatic, ExpeDF_003_4Symptomatic$EH_ID, function (x){
  m.loss <- which(x$relativeWeight == min(x$relativeWeight, na.rm=TRUE))
  x[m.loss,]
}))

max.loss_003_4$infection_isolate <- factor(max.loss_003_4$infection_isolate,
                                           levels = c("E64", "E139"))

ggplot(max.loss_003_4, aes(Mouse_strain,100-relativeWeight, color=infection_isolate)) +
  geom_boxplot(color = "black")+
  ggtitle("Maximum weigth loss during the symptomatic phase") +
  facet_wrap(~infection_isolate) +
  geom_jitter(width=0.1, size=7, pch = 21,
              color = "black", aes(fill = Mouse_strain), alpha = 0.8) +
  labs(y= "Maximum weigth loss relative to weight at dpi 3", x= "Mouse strain")+
  mytheme +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

kruskal.test(relativeWeight ~ Mouse_strain, data = max.loss_003_4)
pairwise.wilcox.test(max.loss_003_4$relativeWeight, max.loss_003_4$Mouse_strain,
                 p.adjust.method = "BH")
```

## 2. Parasite shedding

```{r OPGalong3, echo=FALSE, warning=FALSE, fig.width = 12, fig.height = 10}
ggplot(ExpeDF_003_4, aes(x = dpi, y = OPG, fill = infection_isolate))+
  # geom_rect(aes(xmin = 3, xmax = 8, ymin = -Inf, ymax = Inf), fill = "lightgrey", alpha = .5) +
  geom_line(aes(group = EH_ID, col = Mouse_strain), alpha = 0.5, size = 2) +
  geom_point(size=3, aes(color = Mouse_strain))+
  # scale_color_manual(values = c("blue", "purple", "red")) +
  facet_grid(Mouse_strain ~ infection_isolate) +
  mytheme +
  scale_x_continuous(breaks = 0:11, name = "Day post infection (dpi)") +
  ylab("Oocysts shedding along infection (OPG)") +
  ggtitle("Oocyst shedding along experiment") +
  theme(legend.position="none") 
```

```{r OPGalongsum3, echo=FALSE, warning=FALSE, fig.width = 12, fig.height = 10}
ggplot(summaryOocysts_003_4, aes(x = dpi, y = OPG))+
  # geom_rect(aes(xmin = 3, xmax = 8, ymin = -Inf, ymax = Inf), fill = "lightgrey", alpha = .5) +
  geom_errorbar(aes(ymin = OPG - ci, ymax = OPG + ci, col = Mouse_strain), alpha = 0.7) +
  geom_line(aes(group = Mouse_strain, col = Mouse_strain), size = 2) +
  geom_point(aes(fill = Mouse_strain), size=4, pch = 21, color = "black") +
  mytheme +
  facet_grid(Mouse_strain ~ infection_isolate) +
  scale_x_continuous(breaks = 0:11, name = "Day post infection (dpi)") +
  scale_y_continuous(name = "Oocysts shedding along infection (OPG)") +
  theme(legend.position="none") +
  ggtitle("Mean oocysts shedding along experiment")
```

```{r stats3opg, echo=FALSE, warning=FALSE, fig.width = 12, fig.height = 10}
# Cumulative OPG along experiment
all.sum.oocysts_003_4 <- do.call("rbind", by(ExpeDF_003_4, ExpeDF_003_4$EH_ID, function (x){
  x$sum.oo <- sum(x$OPG, na.rm = TRUE)
  x
}))
sum.oocysts_003_4 <- all.sum.oocysts_003_4[!duplicated(all.sum.oocysts_003_4$EH_ID),]

ggplot(sum.oocysts_003_4, aes(Mouse_strain, sum.oo, color=infection_isolate)) +
  geom_boxplot(color = "black")+
  ggtitle("Sum of oocysts shed along the experiment") +
  facet_wrap(~infection_isolate) +
  geom_jitter(width=0.1, size=7, pch = 21,
              color = "black", aes(fill = Mouse_strain), alpha = 0.8) +
  labs(y= "Sum of oocysts shed along experiment, OPG (oocysts per gram)", x= "Mouse strain")+
  # scale_fill_manual(values = c("blue", "purple", "red")) +
  mytheme +
  theme(legend.position="none")

kruskal.test(sum.oo ~ Mouse_strain, data = sum.oocysts_003_4)
pairwise.wilcox.test(sum.oocysts_003_4$sum.oo, sum.oocysts_003_4$Mouse_strain,
                 p.adjust.method = "BH")
```

# Expe_005, July 2018, FULL experiment (parents, intra specific and inter species hybrids) BUSNA, STRA, SCHUNT, PWD, infection with Eferrisi and Efalciformis (E64 and E88)

```{r setupExpe5, echo=FALSE, warning=FALSE}
########################### Exp005 : Full expe including hybrids, July 2018 
oo <- read.csv("../data/3_recordingTables/Exp005_full_RECORDoocysts.csv", na.strings = c("NA", " "))
we <- read.csv("../data/3_recordingTables/Exp005_full_RECORDweight.csv", na.strings = c("NA", " "))
design <- rbind(read.csv("../data/2_designTables/Inf1a_Exp005.DESIGN.csv", na.strings = c("NA", " ")),
                read.csv("../data/2_designTables/Inf2a_Exp005.DESIGN.csv", na.strings = c("NA", " ")),
                read.csv("../data/2_designTables/Inf1b_Exp005.DESIGN.csv", na.strings = c("NA", " ")),
                read.csv("../data/2_designTables/Inf2b_Exp005.DESIGN.csv", na.strings = c("NA", " ")))
# Correct error
names(design)[names(design) == "EH_id"] <- "EH_ID"
# Correct space error
design$EH_ID <- gsub(" ", "", design$EH_ID)
design$HybridStatus <- gsub(" ", "", design$HybridStatus)
ExpeDF_005 <- merge(oo, we, by = c("labels", "Expe"))
ExpeDF_005 <- merge(ExpeDF_005, design, by = "EH_ID", all.x = T)
## Correct error space
ExpeDF_005$Strain <- gsub(" ", "", ExpeDF_005$Strain)
# Correct error non numeric
ExpeDF_005$weight <- as.numeric(as.character(ExpeDF_005$weight))
ExpeDF_005$weight_dpi0 <- as.numeric(as.character(ExpeDF_005$weight_dpi0))
# Correct weight loss
ExpeDF_005$weightloss <- ExpeDF_005$weight_dpi0 - ExpeDF_005$weight

# Add mice subspecies info
ExpeDF_005$Mouse_subspecies <- factor(as.factor(ExpeDF_005$Strain),
                                  levels = c("BUSNA_BUSNA","BUSNA_PWD","BUSNA_STRA","PWD_BUSNA",
                                             "PWD_PWD","PWD_SCHUNT","SCHUNT_PWD","SCHUNT_SCHUNT",
                                             "SCHUNT_STRA","STRA_BUSNA","STRA_SCHUNT","STRA_STRA"),
                                  labels = c("M.m.musculus P", "M.m.musculus F1",
                                             "Hybrid", "M.m.musculus F1",
                                             "M.m.musculus P","Hybrid",
                                             "Hybrid", "M.m.domesticus P",
                                             "M.m.domesticus F1","Hybrid",
                                             "M.m.domesticus F1","M.m.domesticus P"))
# # Mouse_strain: West should always be left
ExpeDF_005$Mouse_strain <- factor(as.factor(ExpeDF_005$Strain),
                                  levels = c("BUSNA_BUSNA","BUSNA_PWD",
                                             "BUSNA_STRA","PWD_BUSNA",
                                             "PWD_PWD","PWD_SCHUNT",
                                             "SCHUNT_PWD","SCHUNT_SCHUNT",
                                             "SCHUNT_STRA","STRA_BUSNA",
                                             "STRA_SCHUNT","STRA_STRA"),
                                  labels = c("M.m.musculus P \n(BUSNA_BUSNA)", "M.m.musculus F1 \n(BUSNA_PWD)",
                                             "Hybrid \n(BUSNA_STRA)", "M.m.musculus F1 \n(PWD_BUSNA)",
                                             "M.m.musculus P \n(PWD_PWD)","Hybrid \n(PWD_SCHUNT)",
                                             "Hybrid \n(SCHUNT_PWD)", "M.m.domesticus P \n(SCHUNT_SCHUNT)",
                                             "M.m.domesticus F1 \n(SCHUNT_STRA)","Hybrid \n(STRA_BUSNA)",
                                             "M.m.domesticus F1 \n(STRA_SCHUNT)","M.m.domesticus P \n(STRA_STRA)"))

# Correct hybrid status
ExpeDF_005$HybridStatus <- factor(ExpeDF_005$HybridStatus,
                                  levels = c("intersubsp.hybrids", "outbredhybrids", "parentalstrains"),
                                  labels = c("hybrids", "outbred", "parents"))

# Add infection isolate
ExpeDF_005$infection_isolate <- ExpeDF_005$Eimeria

# Enter Eimeria species
ExpeDF_005$Eimeria_species[ExpeDF_005$infection_isolate %in% c("E88", "Eflab", "EfLab")] <- "E.falciformis"
ExpeDF_005$Eimeria_species[ExpeDF_005$infection_isolate %in% c("E64", "EI64", "E139")] = "E.ferrisi"

# # Age at infection
# ExpeDF_005$ageAtInfection[ExpeDF_005$Batch == 1] <- round(ExpeDF_005$ageAtdpi0expe1a)
# ExpeDF_005$ageAtInfection[ExpeDF_005$Batch == 2] <- round(ExpeDF_005$ageAtdpi0expe1a +2)

# calculate OPG 
# rename 
names(ExpeDF_005) <- gsub("oocyst_sq", "Neubauer", names(ExpeDF_005))
names(ExpeDF_005) <- gsub("dilution", "dilution_ml", names(ExpeDF_005))
ExpeDF_005$dilution_ml <- as.numeric(as.character(ExpeDF_005$dilution_ml))
ExpeDF_005$fecweight <- as.numeric(as.character(ExpeDF_005$fecweight))
# Replace NA by 0
ExpeDF_005$fecweight[is.na(ExpeDF_005$fecweight)] <- 0

ExpeDF_005 <- calculateOPG(ExpeDF = ExpeDF_005)

# Add OPG status
ExpeDF_005$OPGstatus[is.na(ExpeDF_005$OPG)] = "na"
ExpeDF_005$OPGstatus[!is.na(ExpeDF_005$OPG) & ExpeDF_005$OPG > 0] = "positive"
ExpeDF_005$OPGstatus[!is.na(ExpeDF_005$OPG) & ExpeDF_005$OPG == 0] = "negative"
ExpeDF_005$OPGstatus = as.factor(ExpeDF_005$OPGstatus)

# Split in 2 infection batches (Efalciformis and Eferrisi are studied separetely)
ExpeDF_005_E88 <- ExpeDF_005[ExpeDF_005$infection_isolate %in% "E88",]
ExpeDF_005_E64 <- ExpeDF_005[ExpeDF_005$infection_isolate %in% "E64",]

# calculate relative weight loss compared to dpi3 for E64
ExpeDF_005_E64 <- calculateWeightLoss(ExpeDF_005_E64, startingDay = 3)
ExpeDF_005_E64$relativeWeight <- as.numeric(as.character(ExpeDF_005_E64$relativeWeight))

# calculate relative weight loss compared to dpi7 for E88
ExpeDF_005_E88 <- calculateWeightLoss(ExpeDF_005_E88, startingDay = 7)
ExpeDF_005_E88$relativeWeight <- as.numeric(as.character(ExpeDF_005_E88$relativeWeight))

# calculate summary statistics on weight loss
summaryWeight_005_E64 <- summarySE(ExpeDF_005_E64, measurevar = "relativeWeight",
                           groupvars=c("HybridStatus", "dpi", "Expe"), na.rm = T)
summaryWeight_005_E64$ci[is.na(summaryWeight_005_E64$ci)] <- 0

summaryWeight_005_E88 <- summarySE(ExpeDF_005_E88, measurevar = "relativeWeight",
                           groupvars=c("HybridStatus", "dpi", "Expe"), na.rm = T)
summaryWeight_005_E88$ci[is.na(summaryWeight_005_E88$ci)] <- 0

# calculate summary statistics on oocysts shedding
summaryOocysts_005_E64 <-summarySE(ExpeDF_005_E64, measurevar="OPG",
                           groupvars=c("HybridStatus", "dpi", "Expe"), na.rm = T)
summaryOocysts_005_E64$ci[is.na(summaryOocysts_005_E64$ci)] <- 0

summaryOocysts_005_E88 <-summarySE(ExpeDF_005_E88, measurevar="OPG",
                           groupvars=c("HybridStatus", "dpi", "Expe"), na.rm = T)
summaryOocysts_005_E88$ci[is.na(summaryOocysts_005_E88$ci)] <- 0
```

## 1. Weight loss

### Eimeria ferrisi

```{r weightalong5_E64, echo=FALSE, warning=FALSE, fig.width = 12, fig.height = 10}
ggplot(ExpeDF_005_E64, aes(x = dpi, y = weight, fill = OPGstatus)) +
  geom_rect(aes(xmin = 3, xmax = 8, ymin = -Inf, ymax = Inf), fill = "lightgrey", alpha = .5) +
  geom_line(aes(group = EH_ID, col = Mouse_strain), size = 2, alpha = 0.5) +
  # scale_color_manual(values = c("blue", "purple", "red")) +
  geom_point(size=4, pch = 21, color = "black")+
  scale_fill_manual(values = c("lightgrey", "black", "yellow")) +
  mytheme +
  facet_grid(HybridStatus ~ Expe) +
  scale_x_continuous(breaks = 0:11, name = "Day post infection (dpi)") +
  scale_y_continuous(name = "Weight (g)") +
  theme(strip.text.y = element_text(size = 15)) +
  # theme(legend.position="none") +
  ggtitle("Weight along experiment per individual (E64)", subtitle = "yellow : oocysts detected in feces")

ggplot(ExpeDF_005_E64, aes(x = dpi, y = relativeWeight, fill = OPGstatus)) +
  geom_rect(aes(xmin = 3, xmax = 8, ymin = 80, ymax = 110), fill = "lightgrey", alpha = .5) +
  geom_line(aes(group = EH_ID, col = Mouse_strain), size = 2, alpha = 0.5) +
  # scale_color_manual(values = c("blue", "purple", "red")) +
  geom_point(size=4, pch = 21, color = "black")+
  scale_fill_manual(values = c("lightgrey", "black", "yellow")) +
  mytheme +
  facet_grid(HybridStatus ~ Expe) +
  scale_x_continuous(breaks = 0:11, name = "Day post infection (dpi)") +
  scale_y_continuous(name = "Weight relative to dpi3 (%)") +
  theme(strip.text.y = element_text(size = 15)) +
  theme(legend.position="bottom") +
  ggtitle("Relative weight along experiment compared to dpi3 (E64)", subtitle = "yellow : oocysts detected in feces")
```

```{r weightalongsum5_E64, echo=FALSE, warning=FALSE, fig.width = 12, fig.height = 10}
ggplot(summaryWeight_005_E64, aes(x = dpi, y = relativeWeight))+
  geom_rect(aes(xmin = 3, xmax = 8, ymin = -Inf, ymax = Inf), fill = "lightgrey", alpha = .7) +
  geom_errorbar(aes(ymin = relativeWeight - ci, ymax = relativeWeight + ci, col = HybridStatus)) +
  geom_line(aes(group = HybridStatus, col = HybridStatus), size = 2, alpha = 0.5) +
  geom_point(aes(fill = HybridStatus), size=4, pch = 21, color = "black") +
  scale_color_manual(values = c("blue", "purple", "red")) +
  scale_fill_manual(values = c("blue", "purple", "red")) +
  mytheme +
  facet_grid(.~Expe) +
  scale_x_continuous(breaks = 0:11, name = "Day post infection (dpi)") +
  scale_y_continuous(name = "Weight relative to dpi3 (%)") +
  # coord_cartesian(ylim = c(85, 115)) +
  # theme(legend.position="none", strip.text = element_text(size = 15)) +
  ggtitle("Mean relative weight along experiment compared to dpi3 (E64)")
```

For statistical analysis, we compare the maximum relative weight loss between the different groups. We limit our analysis to the period : dpi3 to dpi8 (symptomatic period for E64 strain).

```{r stats5_E64, echo=FALSE, warning=FALSE, fig.width = 12, fig.height = 10}
ExpeDF_005_E64_Symptomatic <- ExpeDF_005_E64[ExpeDF_005_E64$dpi %in% 3:8,]
max.loss_005_E64 <- do.call("rbind", by(ExpeDF_005_E64_Symptomatic, ExpeDF_005_E64_Symptomatic$EH_ID, function (x){
  m.loss <- which(x$relativeWeight == min(x$relativeWeight, na.rm=TRUE))
  x[m.loss,]
}))

# tapply(max.loss$relativeWeight, max.loss$infection_isolate:max.loss$Mouse_strain, mean)
 
ggplot(max.loss_005_E64, aes(HybridStatus,100-relativeWeight, color=infection_isolate)) +
  geom_boxplot(color = "black")+
  ggtitle("Maximum weigth loss during the symptomatic phase") +
  facet_wrap(~Expe) +
  geom_jitter(width=0.1, size=7, pch = 21,
              color = "black", aes(fill = HybridStatus), alpha = 0.8) +
  labs(y= "Maximum weigth loss relative to weight at dpi 3", x= "Hybrid status")+
  # scale_fill_manual(values = c("blue", "purple", "red")) +
  mytheme +
  theme(legend.position="none")

# non-parametric tests
# first batch
maxloss_E64B1 <- max.loss_005_E64[max.loss_005_E64$Expe == "Expe005_1b",]

kruskal.test(relativeWeight ~ HybridStatus, data = maxloss_E64B1)
pairwise.wilcox.test(maxloss_E64B1$relativeWeight, maxloss_E64B1$HybridStatus,
                 p.adjust.method = "BH")
# second batch
maxloss_E64B2 <- max.loss_005_E64[max.loss_005_E64$Expe == "Expe005_2b",]

kruskal.test(relativeWeight ~ HybridStatus, data = maxloss_E64B2)
pairwise.wilcox.test(maxloss_E64B2$relativeWeight, maxloss_E64B2$HybridStatus,
                 p.adjust.method = "BH")

# summary(lmer(relativeWeight ~ HybridStatus + 1|Mouse_strain, data = max.loss_005_E64))
 
# library(nlme)
# lme(fixed = max.loss_005_E64$HybridStatus, data = max.loss_005_E64, random = max.loss_005_E64$Mouse_strain)
```

### Eimeria falciformis

```{r weightalong5_E88, echo=FALSE, warning=FALSE, fig.width = 12, fig.height = 10}
ggplot(ExpeDF_005_E88, aes(x = dpi, y = weight, fill = OPGstatus)) +
  geom_rect(aes(xmin = 7, xmax = 11, ymin = -Inf, ymax = Inf), fill = "lightgrey", alpha = .5) +
  geom_line(aes(group = EH_ID, col = Mouse_strain), size = 2, alpha = 0.5) +
  # scale_color_manual(values = c("blue", "purple", "red")) +
  geom_point(size=4, pch = 21, color = "black")+
  scale_fill_manual(values = c("lightgrey", "black", "yellow")) +
  mytheme +
  facet_grid(Mouse_subspecies ~ Expe, scales = "free") +
  scale_x_continuous(breaks = 0:11, name = "Day post infection (dpi)") +
  scale_y_continuous(name = "Weight (g)") +
  theme(strip.text.y = element_text(size = 15)) +
  # theme(legend.position="none") +
  ggtitle("Weight along experiment per individual (E88)", subtitle = "yellow : oocysts detected in feces")

ggplot(ExpeDF_005_E88, aes(x = dpi, y = relativeWeight, fill = OPGstatus)) +
  geom_rect(aes(xmin = 7, xmax = 11, ymin = 80, ymax = 110), fill = "lightgrey", alpha = .5) +
  geom_line(aes(group = EH_ID, col = Mouse_strain), size = 2, alpha = 0.5) +
  # scale_color_manual(values = c("blue", "purple", "red")) +
  geom_point(size=4, pch = 21, color = "black")+
  scale_fill_manual(values = c("lightgrey", "black", "yellow")) +
  mytheme +
  facet_grid(Mouse_subspecies ~ Expe) +
  scale_x_continuous(breaks = 0:11, name = "Day post infection (dpi)") +
  scale_y_continuous(name = "Weight relative to dpi7 (%)") +
  coord_cartesian(ylim = c(80, 110)) +
  theme(strip.text.y = element_text(size = 15)) +
  # theme(legend.position="none") +
  ggtitle("Relative weight along experiment compared to dpi7 (E88)", subtitle = "yellow : oocysts detected in feces")
```

```{r weightalongsum5_E88, echo=FALSE, warning=FALSE, fig.width = 12, fig.height = 10}
ggplot(summaryWeight_005_E88, aes(x = dpi, y = relativeWeight))+
  geom_rect(aes(xmin = 7, xmax = 11, ymin = -Inf, ymax = Inf), fill = "lightgrey", alpha = .5) +
  geom_errorbar(aes(ymin = relativeWeight - ci, ymax = relativeWeight + ci, col = HybridStatus)) +
  geom_line(aes(group = HybridStatus, col = HybridStatus), size = 2, alpha = 0.5) +
  geom_point(aes(fill = HybridStatus), size=4, pch = 21, color = "black") +
  scale_color_manual(values = c("blue", "purple", "red")) +
  scale_fill_manual(values = c("blue", "purple", "red")) +
  facet_grid(.~Expe) +
  mytheme +
  scale_x_continuous(breaks = 0:11, name = "Day post infection (dpi)") +
  scale_y_continuous(name = "Weight relative to dpi7 (%)") +
  # coord_cartesian(ylim = c(85, 115)) +
  # theme(legend.position="none", strip.text = element_text(size = 15)) +
  ggtitle("Mean relative weight along experiment compared to dpi7 (E88)")
```

For statistical analysis, we compare the maximum relative weight loss between the different groups. We limit our analysis to the period : dpi7 to dpi11 (symptomatic period for E88 strain).

```{r stats5_E88, echo=FALSE, warning=FALSE, fig.width = 12, fig.height = 10}
ExpeDF_005_E88_Symptomatic <- ExpeDF_005_E88[ExpeDF_005_E88$dpi %in% 7:11,]
max.loss_005_E88 <- do.call("rbind", by(ExpeDF_005_E88_Symptomatic, ExpeDF_005_E88_Symptomatic$EH_ID, function (x){
  m.loss <- which(x$relativeWeight == min(x$relativeWeight, na.rm=TRUE))
  x[m.loss,]
}))

# tapply(max.loss$relativeWeight, max.loss$infection_isolate:max.loss$Mouse_strain, mean)

ggplot(max.loss_005_E88, aes(HybridStatus,100-relativeWeight, color=infection_isolate)) +
  geom_boxplot(color = "black")+
  ggtitle("Maximum weigth loss during the symptomatic phase") +
  facet_wrap(~Expe) +
  geom_jitter(width=0.1, size=7, pch = 21,
              color = "black", aes(fill = HybridStatus), alpha = 0.8) +
  labs(y= "Maximum weigth loss relative to weight at dpi 7", x= "Mouse strain")+
  # scale_fill_manual(values = c("blue", "purple", "red")) +
  mytheme +
  theme(legend.position="none")

# non-parametric tests
# first batch
maxloss_E88B1 <- max.loss_005_E88[max.loss_005_E88$Expe == "Expe005_1a",]

kruskal.test(relativeWeight ~ HybridStatus, data = maxloss_E88B1)
pairwise.wilcox.test(maxloss_E88B1$relativeWeight, maxloss_E88B1$HybridStatus,
                 p.adjust.method = "BH")

# second batch
maxloss_E88B2 <- max.loss_005_E88[max.loss_005_E88$Expe == "Expe005_2a",]

kruskal.test(relativeWeight ~ HybridStatus, data = maxloss_E88B2)
pairwise.wilcox.test(maxloss_E88B2$relativeWeight, maxloss_E88B2$HybridStatus,
                 p.adjust.method = "BH")

# summary(glmer(relativeWeight ~ HybridStatus + 1|Mouse_strain, data = max.loss_005_E88))
# myfitE88 <- lmer(weight ~ HybridStatus + 1|dpi + 1|EH_ID + 1|Sex, data = ExpeDF_005_E88)
# print("Along all experiment:")
# lmer(weight ~ HybridStatus, data = ExpeDF_005_E88)
# myfitE88 <- lmer(weight ~ HybridStatus + 1|dpi, data = ExpeDF_005_E88)
# myfitE88
# summary(myfitE88)
```

## 2. Parasite shedding

```{r OPGalong5_64, echo=FALSE, warning=FALSE, fig.width = 12, fig.height = 10}
ggplot(ExpeDF_005_E64, aes(x = dpi, y = OPG, fill = infection_isolate))+
  geom_rect(aes(xmin = 3, xmax = 8, ymin = -Inf, ymax = Inf), fill = "lightgrey", alpha = .5) +
  geom_line(aes(group = EH_ID, col = Mouse_strain), alpha = 0.5, size = 2) +
  geom_point(size=3, aes(color = Mouse_strain))+
  # scale_color_manual(values = c("blue", "purple", "red")) +
  facet_grid(HybridStatus ~ Expe) +
  mytheme +
  scale_x_continuous(breaks = 0:11, name = "Day post infection (dpi)") +
  ylab("Oocysts shedding along infection (OPG)") +
  ggtitle("Oocyst shedding along experiment (E64)") +
  theme(legend.position="none") 
```

```{r OPGalongsum5_64, echo=FALSE, warning=FALSE, fig.width = 12, fig.height = 10}
ggplot(summaryOocysts_005_E64, aes(x = dpi, y = OPG))+
  geom_rect(aes(xmin = 3, xmax = 8, ymin = -Inf, ymax = Inf), fill = "lightgrey", alpha = .5) +
  geom_errorbar(aes(ymin = OPG - ci, ymax = OPG + ci,  col= HybridStatus)) +
  geom_line(aes(group = HybridStatus, col = HybridStatus), size = 2, alpha = 0.5) +
  geom_point(aes(fill = HybridStatus), size=4, pch = 21, color = "black") +
  # scale_color_manual(values = c("blue", "purple", "red")) +
  # scale_fill_manual(values = c("blue", "purple", "red")) +
  mytheme +
  facet_grid(HybridStatus ~ Expe) +
  scale_x_continuous(breaks = 0:11, name = "Day post infection (dpi)") +
  scale_y_continuous(name = "Oocysts shedding along infection (OPG)") +
  ggtitle("Mean oocysts shedding along experiment")
```

```{r stats5_64opg, echo=FALSE, warning=FALSE, fig.width = 12, fig.height = 10}
# Cumulative OPG along experiment
all.sum.oocysts_005_64 <- do.call("rbind", by(ExpeDF_005_E64, ExpeDF_005_E64$EH_ID, function (x){
  x$sum.oo <- sum(x$OPG, na.rm = TRUE)
  x
}))
sum.oocysts_005_64 <- all.sum.oocysts_005_64[!duplicated(all.sum.oocysts_005_64$EH_ID),]

ggplot(sum.oocysts_005_64, aes(HybridStatus, sum.oo, color=infection_isolate)) +
  geom_boxplot(color = "black")+
  ggtitle("Sum of oocysts shed along the experiment") +
  facet_wrap(~infection_isolate) +
  geom_jitter(width=0.1, size=7, pch = 21,
              color = "black", aes(fill = Mouse_strain), alpha = 0.8) +
  labs(y= "Sum of oocysts shed along experiment, OPG (oocysts per gram)", x= "Mouse strain")+
  # scale_fill_manual(values = c("blue", "purple", "red")) +
  mytheme +
  facet_grid(.~ Expe) +
  theme(legend.position="none")

kruskal.test(sum.oo ~ HybridStatus, data = sum.oocysts_005_64)
pairwise.wilcox.test(sum.oocysts_005_64$sum.oo, sum.oocysts_005_64$HybridStatus,
                 p.adjust.method = "BH")
```

Eimeria falciformis

```{r OPGalong5_88, echo=FALSE, warning=FALSE, fig.width = 12, fig.height = 10}
ggplot(ExpeDF_005_E88, aes(x = dpi, y = OPG, fill = infection_isolate))+
  geom_rect(aes(xmin = 7, xmax = 11, ymin = -Inf, ymax = Inf), fill = "lightgrey", alpha = .5) +
  geom_line(aes(group = EH_ID, col = Mouse_strain), alpha = 0.5, size = 2) +
  geom_point(size=3, aes(color = Mouse_strain))+
  # scale_color_manual(values = c("blue", "purple", "red")) +
  facet_grid(HybridStatus ~ Expe) +
  mytheme +
  scale_x_continuous(breaks = 0:11, name = "Day post infection (dpi)") +
  ylab("Oocysts shedding along infection (OPG)") +
  ggtitle("Oocyst shedding along experiment (E88)") +
  theme(legend.position="none") 
```

```{r OPGalongsum5_88, echo=FALSE, warning=FALSE, fig.width = 12, fig.height = 10}
ggplot(summaryOocysts_005_E88, aes(x = dpi, y = OPG))+
  geom_rect(aes(xmin = 7, xmax = 11, ymin = -Inf, ymax = Inf), fill = "lightgrey", alpha = .5) +
  geom_errorbar(aes(ymin = OPG - ci, ymax = OPG + ci,  col= HybridStatus)) +
  geom_line(aes(group = HybridStatus, col = HybridStatus), size = 2, alpha = 0.5) +
  geom_point(aes(fill = HybridStatus), size=4, pch = 21, color = "black") +
  # scale_color_manual(values = c("blue", "purple", "red")) +
  # scale_fill_manual(values = c("blue", "purple", "red")) +
  mytheme +
  facet_grid(HybridStatus ~ Expe) +
  scale_x_continuous(breaks = 0:11, name = "Day post infection (dpi)") +
  scale_y_continuous(name = "Oocysts shedding along infection (OPG)") +
  ggtitle("Mean oocysts shedding along experiment (E88)")
```


```{r stats5_88opg, echo=FALSE, warning=FALSE, fig.width = 12, fig.height = 10}
# Cumulative OPG along experiment
all.sum.oocysts_005_88 <- do.call("rbind", by(ExpeDF_005_E88, ExpeDF_005_E88$EH_ID, function (x){
  x$sum.oo <- sum(x$OPG, na.rm = TRUE)
  x
}))
sum.oocysts_005_88 <- all.sum.oocysts_005_88[!duplicated(all.sum.oocysts_005_88$EH_ID),]

ggplot(sum.oocysts_005_88, aes(HybridStatus, sum.oo, color=infection_isolate)) +
  geom_boxplot(color = "black")+
  ggtitle("Sum of oocysts shed along the experiment") +
  facet_wrap(~infection_isolate) +
  geom_jitter(width=0.1, size=7, pch = 21,
              color = "black", aes(fill = Mouse_strain), alpha = 0.8) +
  labs(y= "Sum of oocysts shed along experiment, OPG (oocysts per gram)", x= "Mouse strain")+
  # scale_fill_manual(values = c("blue", "purple", "red")) +
  mytheme +
  facet_grid(.~ Expe) +
  theme(legend.position="none")

kruskal.test(sum.oo ~ HybridStatus, data = sum.oocysts_005_88)
pairwise.wilcox.test(sum.oocysts_005_88$sum.oo, sum.oocysts_005_88$HybridStatus,
                 p.adjust.method = "BH")
```


Ideas:

* Add variable for each 4 parents and test the linear relationships for each of these variables set to 0 (copy of DNA), 1 (copy of DNA) (2 we can remove as we want outbred vs hybrids) + another variable HybridStatus : hybrid or outbred. + mixed effect (1|EH_ID, 1|Expe)

* Depend on the angle, but could be really interesting to quantify this for each mouse strain (outbreeding effet + hybrid effect) and show that it is highly strain specific. The focus on the article could be on that.

* Internal collaborators:
Alice Balard, 
Vivian Mittné, 
Francisca Böhning, 
Emanuel Heitlinger

* External collaborators:
Stuart J. Baird, 
Jaroslav Piálek, 
Ľudovít Ďureje, 
Joëlle Goüy de Bellocq, 
Milos Macholán.

* Aknowledgements: 
Victor Jarquin, 
Jenny Jost, 
Deborah Dymke, 
Lubomír Bednář, 
Parnika Mukherjee, 
Julia Murata, 
Clément Vollet, 
Tabea Roth von Szepesbéla, 
Yasmin Schickel, 
Gordon Mählis
